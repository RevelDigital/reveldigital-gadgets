<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Google Spreadsheet Gadget" description="Basic tabular display of Google spreadsheet data" author="RevelDigital" background="transparent">
  <UserPref name="spreadsheetUrl" display_name="Published spreadsheet URL" datatype="string" />
  <UserPref name="hasTitle" display_name="Use first row as header"  datatype="bool" default_value="true" />
  <UserPref name="header-style" display_name="Header Style" datatype="style" default_value="font-family:Verdana;color:rgb(255, 255, 255);font-size:24px;" required="true" />
  <UserPref name="scrollSpeed" display_name="Seconds per scroll ( 0 = disable )" datatype="string" />
  <UserPref name="body-style" display_name="Body Style" datatype="style" default_value="font-family:Verdana;color:rgb(255, 255, 255);font-size:18px;" required="true" />
  <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
  <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" />
</ModulePrefs>
<Content type="html"> 
<![CDATA[

<style type="text/css">
body *
{
  line-height: 1.2em; 
  letter-spacing: 0; 
  word-spacing: normal; 
}

body
{
  background: transparent;
  overflow: hidden;
}


/* define height and width of scrollable area. Add 16px to width for scrollbar          */
#container {
	clear: both;
	width: __UP_rdW__px;
	height: __UP_rdH__px;
}

th {
	text-align:left;	
}

#tableHeader {
	width: __UP_rdW__px;
	__UP_header-style__ 
}
#dataTable {
  position: absolute;
	width: __UP_rdW__px;
	__UP_body-style__
}
#tableContainer {
  position: relative;
	overflow: hidden;
	width: __UP_rdW__px;
	height: __UP_rdH__px;
}

</style>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="https://reveldigital-gadgets.googlecode.com/svn/branches/dave/jquery.csv-0.71.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<div id="container">
  <div id="headerContainer"></div>
  <div id="tableContainer"></div>
</div>

<script type="text/javascript">

  var header;
  var table;
  var rowIndex = 0;
  var numRows;
  var timer;
  var prefs = new gadgets.Prefs();
  
  gadgets.util.registerOnLoadHandler(initialize);
  
  function initialize() {
    $.get(googleUrl(prefs.getString("spreadsheetUrl")), function(data) {
      var arr = $.csv.toArrays(data);
      if (prefs.getBool("hasTitle")) {  // Static header

        var headerArr = arr.shift();
        var tableHeader = $("<table id='tableHeader'/>");
        var thead = $("<thead class='fixedHeader'/>");
        
        for (var col in headerArr) {
          thead.append($("<th>" + headerArr[col] + "</th>"));
        }
        tableHeader.append(thead);
        $('#headerContainer').append(tableHeader);
      }

      var dataTable = $("<table id='dataTable'/>");
      numRows = 0;
      for (var row in arr) {
        var tr = $("<tr id='r_" + row + "'/>");
        for (var col in arr[row]) {
          if(arr[row][col] == ""){
            arr[row][col] = " ";
          }
          tr.append($("<td>" + arr[row][col] + "</td>"));
        }
        dataTable.append(tr);
        numRows++;
      }

      $('#tableContainer').append(dataTable);

      //$("#tableHeader tr th").each(function (i) {
      //  $(this).width($($("#tableContainer tr:first td")[i]).width());
      //})

      $("#dataTable tr").each(function (i) {
        $(this).height($("#r_1").height());
      });
      if (parseFloat(prefs.getString("scrollSpeed")) > 0) {
        if ($('#dataTable').height() > $('#tableContainer').height()) {
          setTimeout(scrollTable, 1000);
        }
      }
    });
  }
  
	function scrollTable(){
		rowIndex++;
		
		var curRow = $('#dataTable tr:nth-child(' + (rowIndex+1) + ')');
				
		if (rowIndex >= numRows){
			setTimeout(function() {
        $('#tableContainer').animate({
          top: 0
        }, 1000, 'linear', function() {
          rowIndex = 0;
          setTimeout(scrollTable, parseFloat(1000));
        })
      }, 3000);
		} else {
			$('#dataTable').animate({top: -curRow.position().top});
			setTimeout(scrollTable, parseFloat(prefs.getString("scrollSpeed")) * 1000);
		}
	}

  function googleUrl(sourceIdentifier) {
    var url, key;
    if (sourceIdentifier.match(/http(s)*:/)) {
      url = sourceIdentifier;
      try {
        key = url.replace(/.*key=/,'').replace(/&.*/,'');
      } catch (error) {
        key = url.match(/(cells|list|values)\/(.*?)\//)[2];
      }
    } else {
      key = sourceIdentifier;
    }    
    var ret = "https://spreadsheets.google.com/pub?key=" + key + "&hl=en&output=csv";
    return ret;
  }
  
  function googleUrl(sourceIdentifier) {
    var url, key;
    if (sourceIdentifier.match(/http(s)*:/)) {
      url = sourceIdentifier;
      try {
        key = url.replace(/.*key=/,'').replace(/&.*/,'');
      } catch (error) {
        key = url.match(/(cells|list|values)\/(.*?)\//)[2];
      }
    } else {
      key = sourceIdentifier;
    }
    var ret = https://docs.google.com/spreadsheets/d/" + key + "/export?gid=0&format=csv";
    return ret;
  }
</script>

]]>
</Content>
</Module> 