<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Google Spreadsheet Gadget" description="Basic tabular display of Google spreadsheet data" author="RevelDigital" background="transparent">
  <UserPref name="spreadsheetUrl" display_name="Published spreadsheet URL" datatype="string" />
  <UserPref name="hasTitle" display_name="Use first row as header"  datatype="bool" default_value="true" />
  <UserPref name="header-style" display_name="Header Style" datatype="style" default_value="font-family:Verdana;color:rgb(255, 255, 255);font-size:24px;" required="true" />
  <UserPref name="scrollSpeed" display_name="Seconds per scroll ( 0 = disable )" datatype="string" />
  <UserPref name="body-style" display_name="Body Style" datatype="style" default_value="font-family:Verdana;color:rgb(255, 255, 255);font-size:18px;" required="true" />
  <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
  <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" />
</ModulePrefs>
<Content type="html"> 
<![CDATA[

<style type="text/css">
body *
{
  line-height: 1.2em; 
  letter-spacing: 0; 
  word-spacing: normal; 
}

body
{
  background: transparent;
}


/* define height and width of scrollable area. Add 16px to width for scrollbar          */
#container {
	clear: both;
	width: __UP_rdW__px;
	height: __UP_rdH__px;
}

th{
	text-align:left;	
}

#tableHeader{
	width: __UP_rdW__px;
	__UP_header-style__ 
}
#dataTable{
	width: __UP_rdW__px;
	__UP_body-style__
	
}
#tableContainer{
	height: __UP_rdH__px;
	overflow:hidden;
	width: __UP_rdW__px;	
}

</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="https://reveldigital-gadgets.googlecode.com/svn/branches/dave/jquery.csv-0.71.js"></script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>

<div id="container">
    <div id="headerContainer"></div>
    <div id="tableContainer"></div>
</div>

<script type="text/javascript">

  var header;
  var table;
  var rowIndex = 0;
  var numRows;
  var timer;
  var currentY = 0;
  var prefs = new gadgets.Prefs();
  $(document).ready(initialize());
  function initialize() {
	$.get(googleUrl(prefs.getString("spreadsheetUrl")), function(data) {
		var arr = $.csv.toArrays(data);
		if (prefs.getBool("hasTitle")) {  // Static header
			var headerContent = '';
			var headerArr = arr.shift();
			headerContent += '<table id="tableHeader"><thead class="fixedHeader"><tr>';
			for (var col in headerArr) {
				headerContent += '<th>' + headerArr[col] + '</th>';
			}
			headerContent += '</tr></thead></table>';
			$('#headerContainer').html(headerContent); 
		}
		var gen = '';
		gen += '<table id="dataTable">';
		
		numRows = 0;
		
		for (var row in arr) {
			gen += '<tr id="r_'+row+'">';
			for (var col in arr[row]) {
				if(arr[row][col] == ""){
					arr[row][col] = " ";
				}
		   		gen += '<td>' + arr[row][col] + '</td>';
				
			}
			gen += '</tr>';
		}
		gen += '</table>';
		$('#tableContainer').html(gen); 
		
		$("#tableHeader tr th").each(function (i){
			   $(this).width($($("#tableContainer tr:first td")[i]).width());
		})
		
		$("#dataTable tr").each(function (i){
			   $(this).height($("#r_1").height());
		})

		if(parseFloat(prefs.getString("scrollSpeed")) > 0){
			if( $('#dataTable').height() > $('#tableContainer').height() ){
				delayStart();
				//timer = setInterval(moveTable, 50);
				/*
				var dif = $('#dataTable').height() - $('#tableContainer').height();
				numRows = Math.floor(dif / $("#r_1").height());
				
				console.log(Math.floor(numRows));
				timer = setInterval(scrollTable, 6000);
				console.log($('#dataTable').height()+" : "+$('#tableContainer').height());
				console.log($("#r_1").height());
				*/
			}
		}
    });
  }

  	function moveTable(){
		$('#tableContainer').scrollTop($('#tableContainer').scrollTop()+2);
		if(currentY == $('#tableContainer').scrollTop()){
			clearTimeout(timer);
			timer = setTimeout( function(){ $('#tableContainer').animate( {scrollTop: 0}, 1500, 'linear',function() {delayStart()})}, 6000);
		}
		currentY = $('#tableContainer').scrollTop();
		console.log($('#tableContainer').scrollTop());
	}
	
	function delayStart(){
		timer = setInterval(function(){clearTimeout(timer); timer = setInterval(moveTable, 50);}, 6000);
	}
  
	function scrollTable(){
		rowIndex++;
		if(rowIndex == 1){
			clearTimeout(timer)
			timer = setInterval(scrollTable, parseFloat(prefs.getString("scrollSpeed")) * 1000);
		}
		var w = $('#dataTable');
		var curRow = $("#r_"+rowIndex);
		if(rowIndex > numRows){
			clearTimeout(timer);
			timer = setTimeout( function(){ $('#tableContainer').animate( {scrollTop: 0}, 1500, 'linear',function() {rowIndex = 0;clearTimeout(timer);timer = setInterval(scrollTable, 6000);})}, 3000);
			
		}else{
			$('#tableContainer').animate( {scrollTop: curRow.offset().top - w.offset().top}, 200, 'linear');	
		}
		
		//console.log(curRow.offset().top - w.offset().top);
		//console.log(rowIndex +":"+ numRows);
	}

  function googleUrl(sourceIdentifier) {
    var url, key;
    if (sourceIdentifier.match(/http(s)*:/)) {
      url = sourceIdentifier;
      try {
        key = url.replace(/.*key=/,'').replace(/&.*/,'');
      } catch (error) {
        key = url.match(/(cells|list|values)\/(.*?)\//)[2];
      }
    } else {
      key = sourceIdentifier;
    }    
    var ret = "https://spreadsheets.google.com/pub?key=" + key+"&hl=en&output=csv";
    return ret;
  }
</script>

]]>
</Content>
</Module> 