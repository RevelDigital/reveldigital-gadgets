<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital QR Control Test" description="Control digital signage with QR code." author="RevelDigital" background="transparent">
  <UserPref name="apikey" display_name="API Key" datatype="string" default_value="null" required="true" />
  <UserPref name="reg_key" display_name="REG Key" datatype="string" required="true" />
</ModulePrefs>
<Content type="html">
<![CDATA[

<style type="text/css">

body {
    background: transparent;
}

#textview {
    width: 100%;
    height: 100%;
    font-size: 200%;
    background: transparent;
    text-align:center;
}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">


function getDevicebyRegKey(regKey) {
    var image = $.getJSON("http://api.reveldigital.com/devices.json?api_key=" + prefs.getString('api_key'), function (data) {
      
        for(var i=0; i < data.length; i++) {
            var currentDevice = data[i];
            if(currentDevice.registration_key == regKey) {
                deviceId = currentDevice.id;
            }
        }

        waitForMsg();

    });
}



//startup waiting for message from server
$(function() {
    deviceId = null;
    prefs = new gadgets.Prefs();
    console.log("Version bravo: " + 54);
    getDevicebyRegKey(prefs.getString('reg_key'));
});


//show text from source given by server
function showText(text) {
    if(text.length == 0) {
        $("#textview").html("Nothing is queued for playback.");
    }
    else {
        $("#textview").html("You have queued " + text + " for playback!");    
    }
}


//wait for a message from the server
//if success call showText to show text
//if success or error still try pinging the server for data
function waitForMsg(){

    $.ajax({
        type: "GET",
        url: "http://www.lumisnet.com/msgsrv.php?device=" + deviceId,
        crossDomain: true,
        async: true,
        cache: false,
        timeout:5000, 
        success: function(data){ 
            showText($.trim(data))
            setTimeout(
                waitForMsg, 
                5000 
            );
        },
        error: function(XMLHttpRequest, textStatus, errorThrown){
            setTimeout(
                waitForMsg,
                5000
            );
        }
    });
};


</script>

<body>
    <div id="textview">
    </div>
</body>

]]>
</Content>
</Module>