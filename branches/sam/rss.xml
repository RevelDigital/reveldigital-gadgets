<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="cityfusion Rss Feed" description="Displays data from cityfusion rss feed" author="RevelDigital" background="transparent">
  <UserPref name="title-style" display_name="Title Style" datatype="style" default_value="font-family:Tahoma;color:rgb(000, 000, 000);font-size:50px;font-weight:bold;" required="false" />
  <UserPref name="details-style" display_name="Details Style" datatype="style" default_value="font-family:Tahoma;color:rgb(000, 000, 000);font-size:18px;font-weight:bold;" required="false" />
  <UserPref name="update_interval" display_name="Number of minutes between data updates" default_value="60" datatype="string" />
  <UserPref name="refresh_interval" display_name="Number of seconds between item changes" datatype="string" default_value="15" />
  <UserPref name="num_items" display_name="Number items to download and show every update" datatype="string" default_value="100" />
  <UserPref name="tags" display_name="RSS tags to be shown, separated with commas, Example: Downtown,Food,etc" datatype="string" default_value="Downtown" required="true/>
  <UserPref name="feed_url" display_name="Url for RSS feed" datatype="string" default_value=" http://www.cityfusion.ca/events/feed/" />
</ModulePrefs>
<Content type="html">
<![CDATA[

<style type="text/css">

p {
  __UP_details-style__;
}
#rssimage {
  width: 650px;
  height: 550px;
  position: absolute;
  left:100px;
  top:100px;   
}
#textboxarea {
  position: absolute;
  left: 800px;
  top: 60px;
}
#eventname {
  __UP_title-style__;
  text-align: center;
}
body { 
  margin:auto;
  background-color: transparent;
  width:100%; 
  height:100%; 
} 

</style>

<body>
<div id="container">
  <img id="rssimage" src="http://placehold.it/650x550">

  <div id="textboxarea">
    <p id="eventname"></p>

    <p id="venue"></p>

    <p id="address"></p>

    <p id="cost"></p>

    <p id="description"></p>
  </div>
</div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="https://reveldigital-gadgets.googlecode.com/svn/third-party/jquery.zrssfeed.min.js"></script>
<script type="text/javascript">



$(document).ready(function () {
  prefs = new gadgets.Prefs();
  console.log("Version: " + 1);
  items = [];
  preloadImage = [];
  counter = 0;
  lastpubdate = null;
  var tags = prefs.getString("tags");
  tagsArray = tags.split(',');
  console.log(tagsArray);
  updateRss();
  setInterval(updateRss(), prefs.getInt("update_interval") * 60 * 1000);
  setInterval(cycleRss, prefs.getInt("refresh_interval") * 1000);
});


function retrieveElement(xml, element) {
  return xml.substring(xml.indexOf('<' + element + '>') + element.length + 2, xml.indexOf('</' + element + '>'));
}

function htmlDecode(value) {
    if (value) {
        return $('<div />').html(value).text();
    } else {
        return '';
    }
}

function cycleRss() {
  $('#container').fadeOut('slow', function() {
    if(counter == items.length-1) {
    counter = 0;
    }

    item = items[counter]

    $('#rssimage').attr('src', preloadImage[counter].src);
    $('#address').html(htmlDecode(retrieveElement(item, 'address')));
    $('#cost').html(htmlDecode(retrieveElement(item, 'cost')));
    $('#eventname').html(htmlDecode(retrieveElement(item, 'title')));
    $('#venue').html(htmlDecode(retrieveElement(item, 'venue')));
    $('#description').html(htmlDecode(retrieveElement(item, 'description')));

  });
  

  $('#container').fadeIn('slow', function() {
    
  });
  
  counter++;
}

function updateRss() {

  for(var j=0; j<tags.length; j++) {

  }


  $.getJSON('https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&output=json_xml&num=' + prefs.getInt("num_items") + '&callback=?&q=' + prefs.getString("feed_url"), function(json) {

    if (json && json.responseStatus == 200) {
      var xml = json.responseData.xmlString;

      var pubdate = retrieveElement(xml, 'lastBuildDate');
      if(pubdate != lastpubdate) {
        items = [];
        preloadImage = [];
        lastpubdate = pubdate;
        items = xml.split('</item>');
        items[0] = items[0].replace(items[0].substring(0, items[0].indexOf('<item>')), "");

        for(var i=0; i<items.length-1; i++) {
          var loadedImage = new Image();
          loadedImage.src = "http://" + retrieveElement(items[i], 'image');
          preloadImage[i] = loadedImage;
        }
      }
    }
  });
}

</script>

]]>
</Content>
</Module>