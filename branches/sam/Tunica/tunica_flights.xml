<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="Flight Status Gadget" description="Flight status gadget" author="RevelDigital" background="transparent">
  <UserPref name="update_interval" display_name="Interval between data checks (minutes)" datatype="string" default_value="15" />
  <UserPref name="apikey" display_name="API Key" datatype="string" required="true" />
  <UserPref name="arrival" display_name="Type" default_value="arrival" datatype="enum" >
    <EnumValue value="arrival" display_value="Arrivals" />
    <EnumValue value="departure" display_value="Departures" />
  </UserPref>
  <UserPref name="row-a" display_name="Row A Color" datatype="color" default_value="white" required="true" />
  <UserPref name="row-b" display_name="Row B Color" datatype="color" default_value="grey" required="true" />
  <UserPref name="header-style" display_name="Header Style" datatype="style" default_value="font-family:Verdana;color:rgb(0, 0, 0);font-size:18px;" required="true" />
  <UserPref name="row-style" display_name="Row Style" datatype="style" default_value="font-family:Verdana;color:rgb(0, 0, 0);font-size:18px;" required="true" />
  <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
  <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" />
</ModulePrefs>
<Content type="html">
<![CDATA[


<style type="text/css">

  body {
    background: transparent;
  }

  #flight_table {
    text-align:left;
    width:100%;
    border-collapse:collapse;
    height:100%;
  }

  #header {
    __UP_header-style__;
  }

  #rowa {
    __UP_row-style__;
    background-color: __UP_row-a__;
  }

  #rowb {
    __UP_row-style__;
    background-color: __UP_row-b__;
  }

  #logo {
    margin: auto;
    text-align: center;
  }

</style>


<div id="logo">

</div>
<div id="table_container">
 <table id="flight_table"><tbody>
    <tr id="header"><th>Time</th><th>Flight #</th><th>Location</th><th>Airline</th><th>Status</th><th>Gate</th></tr>
  </tbody></table>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

<script type="text/javascript">
  var prefs = new gadgets.Prefs();
  function load() {
    console.log("Version: " + 50);
    getAiportImage();
    refresh();
    setInterval(refresh, prefs.getInt("update_interval") * 60 * 1000);
  }
  gadgets.util.registerOnLoadHandler(load);
</script>



<script type="text/javascript">

flights = [];

  function clearFlights() {
    
    var length = $('#flight_table tbody tr').length;

    for(var i=length-1; i > 0; i--) {
      document.getElementById("flight_table").deleteRow(i);
    }
  }



  function refresh() {
    showFlights();

    clearFlights();

    var toggle = prefs.getString('arrival');

    var url = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D'http%3A%2F%2Fwww.tunicaairport.com%2Fflight-information%2Fflight-schedule'%20AND%20xpath%3D%22%2F%2Fdiv%5B%40id%3D'content'%5D%22&diagnostics=false";

    
    $.ajax({
      url: url,
      dataType: 'JSONP',
      type: 'GET',
      success: function (data) {

        var current = data.results[0];

        if(toggle == 'arrival') {
          try {
              var arrivals = current.substring(current.indexOf('<h3>Arrivals</h3>') + 17, current.indexOf('</table>') + 9).trim();
              createFlights(arrivals, 'arrival');
          }
          catch(e) {

          }
          
        }
        else {
          try {
              var departures = current.substring(current.indexOf('<h3>Departures</h3>') + 20, current.lastIndexOf('</table>') + 9).trim();
              createFlights(departures, 'departure');
          }
          catch(e) {

          }
        }

        if(flights.length == 0) {
          showLogo();
        }
        else {
          displayFlights();  
        }
        

      }
    });
  }




  function showLogo() {
    $('#table_container').fadeOut(1000);
    $('#logo').fadeIn(1000);
  }

  function showFlights() {
    $('#logo').fadeOut(1000);
    $('#table_container').fadeIn(1000);
  }

  function getAiportImage() {
    var image = $.getJSON("http://api.reveldigital.com/media.json?api_key=" + prefs.getString("apikey"), function (data) {
      
      for(var i=0; i < data.length; i++) {
        var currentImage = data[i];
        if(currentImage.file_name.toLowerCase() == 'tunicalogo.png') {
          $('#logo').html('<img src=' + currentImage.file_url + '>');
        }
      }

    });
  }

  function getAirlineImage(airline, row) {

    var image = $.getJSON("http://api.reveldigital.com/media.json?api_key=" + prefs.getString("apikey"), function (data) {
      currentAirline = airline.toLowerCase().replace(" ", "_") + '_logo.png';
      for(var i=0; i < data.length; i++) {
        var currentImage = data[i];
        if(currentImage.file_name.toLowerCase() == currentAirline) {
           $('#flight_table tr:nth-child(' + row + ') td:nth-child(4)').html('<img width=170px height=100px src=' + currentImage.file_url + '>');
        }
      }

    });


  }


  function displayFlights() {
    var rowCounter = 1;

        for (var i = 0; i < flights.length; i++) {

          var currentFlight = flights[i];
          var cells = [];
          var table = document.getElementById("flight_table");
          var row = table.insertRow(rowCounter);

          if(i%2 == 0) {
            row.id='rowa';
          }
          else {
            row.id='rowb';
          }  
          rowCounter++;


          for(var j = 0; j < 6; j++) {
            cells[j] = row.insertCell(j);
          }

          cells[0].innerHTML = currentFlight.time;
          cells[1].innerHTML = currentFlight.number;
          cells[2].innerHTML = currentFlight.fromTo;
          cells[3].innerHTML = getAirlineImage(currentFlight.airline, rowCounter);
          cells[4].innerHTML = currentFlight.status;
          cells[5].innerHTML = currentFlight.gate;
          
        } 
  }



  function Flight(info, type) {
  
  this.airline = info[0].innerHTML.replace(/(<([^>]+)>)/ig,"").trim();
  this.number = info[1].innerHTML.replace(/(<([^>]+)>)/ig,"").trim();
  this.fromTo = info[2].innerHTML.replace(/(<([^>]+)>)/ig,"").trim();
  this.gate = info[3].innerHTML.replace(/(<([^>]+)>)/ig,"").trim();
  this.status = info[4].innerHTML.replace(/(<([^>]+)>)/ig,"").trim();
  this.time = info[5].innerHTML.replace(/(<([^>]+)>)/ig,"").trim();

  this.type = type;

  this.print=print;
  function print() {
    return 'Type: ' + this.type + '\nAirline: ' + this.airline + '\nFlight Number: ' + this.number +
      '\nfromTo: ' + this.fromTo + '\nGate: ' + this.gate +
      '\nStatus: ' + this.status + '\nTime: ' + this.time;
  }

}



  function createFlights(data, type) {
    
    flights.length = 0;
    
  var $data = $(data);

    
  for (var i = 0, row; row = $data[0].rows[i]; i++) {
    row.children[0].innerHTML;

    if(i!=0) {
      var flight = new Flight(row.children, type);
        flights.push(flight);
    }
  }



}





</script>

]]>
</Content>
</Module>