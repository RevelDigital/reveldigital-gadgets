<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Target India Custom Gadget" description="Cycle through product list fetched from Google Spreadshit" author="RevelDigital" background="transparent">
  <UserPref name="spreadsheetUrl" display_name="Published spreadsheet URL" datatype="string" />
  <UserPref name="delay" display_name="Change product every X seconds" datatype="string" />
  <UserPref name="regKey" display_name="Registration Key Tag" datatype="string" />
</ModulePrefs>
<Content type="html">
<![CDATA[
<style type="text/css">
@import url(https://fonts.googleapis.com/css?family=Montserrat:400,700);

body {
    font-family: Montserrat;
}

#parent {
    width: 100%;
    margin: 0px auto;
}

#container {
    width: 75%;
    margin: 0 auto;
}

#product_image {
	width: 100%;
}

.blank {
	height: 25px;
}

#price {
	color: #B50000;
	font-size: 400%;
}

#location {
	color: #000000;
	font-size: 400%;
}

#product_name {
	color: #000000;
	font-size: 300%;
}

#product_desc {
	color: #000000;
	font-size: 250%;
}

.rectangle{
	padding-top: 10px;
	padding-bottom: 10px;
    width:100%;
    background:#B50000;
	text-align: center;
}

#rect_location {
	color: #FFFFFF;
	font-size: 300%;
}

#rect_discount {
	color: #FFFFFF;
	font-size: 300%;
}

#infoContainer {
	position:absolute;
	top: 10px;
	left: 10px;
}
  
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://reveldigital.github.io/reveldigital-gadgets/third-party/tabletop.js" type="text/javascript"></script>

<script type="text/javascript">
	var apiKey = "kOFGVRFEgdmDAZiZhsSG8FfIR22VG1CI";
	var prefs = new gadgets.Prefs();
	var d = [];
	gadgets.util.registerOnLoadHandler(initialize);
	

 
	function initialize() {		
		$('#price').hide();
		$('#location').hide();
		$('#rect_location').hide();
		$('#product_image').hide();
		$('#product_name').hide();
		$('#product_desc').hide();
		$('#rect_discount').hide();
		Tabletop.init( { key: prefs.getString("spreadsheetUrl"),
							 callback: processData,
							 simpleSheet: true } )
	 }
  
	function processData(data, tabletop) {
		for (i = 0; i < data.length; i++) { 
				setInfo(data[i]);
				setInfo("Product code " + data[i].product_code);
				d[i] = data[i].product_code;
		}
		resolveNext(0);
	}
	
	var RevelDigital = {
			 Controller: {
				onCommand: function(name, arg) {
					setInfo("Command recieved name: " + name + " args: " + arg);
					if (name === "decode") {
						setInfo("Barcode: " + arg);
					}
				}
			}
		};
	
	function resolveNext(idx) {
		setTimeout(function () {
			setInfo('Data has '  + d);
			setInfo('Current Item '  + d[idx]);
			var uri = "http://api.target.com/products/v3/" + d[idx] + "?id_type=dpci&store_id=530&mode=online&fields=ids,locations,images,brand,descriptions,pricing,in_store_locations&key=" + apiKey;
            var res = encodeURIComponent(uri);
            setInfo('Initial uri ' + uri);
            setInfo('Encoded uri ' + res);
            $.getJSON("https://as1.reveldigital.com/proxy?url=" + res, function (data) {
				$.each(data, function (index, item) {
                    setInfo("Item is " + JSON.stringify(item));
					setPrice(item.items[0].online_price.current_price);
					setLocation(item.items[0].location_id);
					setImage(item.items[0].image.external_primary_image_url[0]);
					setTitle(item.items[0].reference_data.manufacturer_brand);
					setDescription(decodeURI(item.items[0].online_description.value));
				});
			});
			sendAffidavit(prefs.getString("regKey"), d[idx])
			if (++idx < d.length) {
				resolveNext(idx);
			} else {
				resolveNext(0);
			}
		}, 1000 * parseInt(prefs.getString("delay")))
     }
	 
	function setPrice(data) {
		setInfo('Setting price ' + data);
		var container = $('#price');
		container.fadeOut({
			duration: 1000,
			done: function () {
				container.text("$" + data);
				container.fadeIn();
			}
		});
	}

	function setLocation(data) {
		setInfo('Setting location' + data);
		var container = $('#location');
		container.fadeOut({
			duration: 1000,
			done: function () {
				container.text(data);
				container.fadeIn();
			}
		});
		
		var container2 = $('#rect_location');
		container2.fadeOut({
			duration: 1000,
			done: function () {
				container2.text('Location - ' + data);
				container2.fadeIn();
			}
		});
		
		var container3 = $('#rect_discount');
		container3.fadeOut({
			duration: 1000,
			done: function () {
				container3.fadeIn();
			}
		});
	}

	function setImage(data) {
		setInfo('Setting Image ' + data);
		var container = $('#product_image');
		container.fadeOut({
			duration: 1000,
			done: function () {
				container.attr("src", data);
				container.fadeIn();
			}
		});
	}

	function setTitle(data) {
		setInfo('Setting Title ' + data);
		var container = $('#product_name');
		container.fadeOut({
			duration: 1000,
			done: function () {
				container.text(data);
				container.fadeIn();
			}
		});
	}

	function setDescription(data) {
		setInfo('Setting Desc ' + data);
		var container = $('#product_desc');
		container.fadeOut({
			duration: 1000,
			done: function () {
				container.text(data);
				container.fadeIn();
			}
		});
	}
	
	function setInfo(data) {
		if (true) {
			var container = $('#infoContainer');
			container.append(data + '<br>');
		}	
		if (true) {
			console.log(data);
		}
		if (false) {
			alert(data);
		}
	}
	
	function sendAffidavit(regKey, fileId) {
		var offset = (new Date()).getTimezoneOffset() * 60000;
		var d = (new Date(Date.now() - offset)).toISOString();
		var tmp = [{ "timestamp": d, "file_id": fileId.hashCode(), "user_id":999999}];
		setInfo("Sending " + JSON.stringify(tmp) + " to " + 'https://svc1.reveldigital.com/v3/device/affidavit/' + regKey);
		setInfo("Sending " + tmp);
        $.ajax({
            url: 'https://svc1.reveldigital.com/v3/device/affidavit/' + regKey,
            type: 'post',
            contentType: 'application/json',
			dataType: 'json',
            success: function (data) {
                setInfo("Success: " + data);
            },
			error: function (request, status, error) {
				setInfo("Error: " + error + " Status: " + status + " Request: " + JSON.stringify(request));
			},
            data: JSON.stringify(tmp),
        });
    }
	
	String.prototype.hashCode = function() {
		var hash = 0, i, chr, len;
		if (this.length == 0) return hash;
		for (i = 0, len = this.length; i < len; i++) {
			chr   = this.charCodeAt(i);
			hash  = ((hash << 5) - hash) + chr;
			hash |= 0;
		}
		return hash;
	};
</script>
<body>
	<div id="parent">  
		<div id="container">
			<img id="product_image" src=""></img>
			<div class="blank"></div>
			<div>
				<table width="100%">
					<tr>
						<td style="text-align: left;">
							<p id="price"></p>
						</td>
						<td style="text-align: right;">
							<p id="location"></p>
						</td>
					</tr>
					<tr>
						<td colspan= "2" style="text-align: left;">
							<p id="product_name"></p>
						</td>
					</tr>
					<tr>
						<td colspan= "2" style="text-align: left;">
							<p id="product_desc"></p>
						</td>
					</tr>
				</table>
			</div>
			<div class="blank"></div>
			<div class="rectangle">
				<p id="rect_location"></p>
			</div>
			<div class="blank"></div>
			<div class="rectangle">
				<p id="rect_discount">20% OFF</p>
			</div>
		</div>
		<p id="infoContainer"></p>
	</div>
</body>]]>
</Content>
</Module>