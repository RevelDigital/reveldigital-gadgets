<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Surf Info Gadget" description="Surf Gadget" author="RevelDigital" background="transparent">
  <UserPref name="apikey" display_name="Api Key" datatype="string" />
  <UserPref name="timer" display_name="Cycle Time (sec)" datatype="string" />
  <UserPref name="spotId0" display_name="Spot 1 ID." datatype="string" />
  <UserPref name="spotLoc0" display_name="Spot 1 Location." datatype="string" />
  <UserPref name="spotName0" display_name="Spot 1 Name." datatype="string" />
  <UserPref name="spotId1" display_name="Spot 2 ID." datatype="string" />
  <UserPref name="spotLoc1" display_name="Spot 2 Location." datatype="string" />
  <UserPref name="spotName1" display_name="Spot 2 Name." datatype="string" />
  <UserPref name="gadgetWidth" display_name="Width" required="true" default_value="100" datatype="hidden" />
  <UserPref name="gadgetHeight" display_name="Height" required="true" default_value="100" datatype="hidden" />
</ModulePrefs>
<Content type="html">
<![CDATA[
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<style type="text/css">

	body {
		background: transparent;
        background-image: url("http://s15.postimg.org/ek4st1k3v/background.png");
        background-repeat: no-repeat;
	}
    
    .inline {
        display:  inline;
        width: 100%;
    }
    
    .table { 
        overflow:hidden; 
        width:  639px;
    }
    
    .left { 
        float:left; width:400px; 
    }
    
    .right { 
        float:right; width:239px;  
    }
    
    #location {
        color: #000;
        text-align: left;
        font-size: medium;
        margin-top: 60px;
        margin-left: 90px;
    }
	
    #location_name {
        color: #000;
        text-align: left;
        font-size: 45px;
        font-family: Calibri;
        margin-top: 5px;
        margin-left: 90px;
        height: 60px;
        width: 20px;
    }
    
    #overview {
        color: #000;
        text-align: left;
        font-size: 30px;
        font-family: Calibri;
        margin-top: 5px;
        margin-left: 90px;
    }
    
    #weather_icon {
        margin-right: 20px;
        height: 100px;
        width: 100px;
    }
    
    #swell_icon {
        margin-right: 20px;
        height: 60px;
        width: 60px;
    }
    
    #wind_icon {
        margin-right: 20px;
        height: 60px;
        width: 60px;
    }
       
    table {
        border: none;
        border-collapse: collapse;
		width: 100%;
    }
	
	.label {
	text-align: left;
		font-size:24px; 
		font-family:Lucida Sans Unicode;
	}
	
	.value {
		font-size:22px; 
		font-family:Lucida Sans Unicode;
	}
    
</style>
<script type="text/javascript">
		var prefs = new gadgets.Prefs();
        var G_INDEX = 0;
		function init() {
            resolveNext(G_INDEX);
		}
		  
		gadgets.util.registerOnLoadHandler(init);
		
        function resolveNext(idx) {
            var uri = "http://magicseaweed.com/api/" + prefs.getString("apikey") + "/forecast/?spot_id=" + prefs.getString("spotId" + idx) + "&fields=timestamp,swell.*,wind.*,condition.temperature,condition.weather,condition.unit";
            var res = encodeURIComponent(uri);
            setInfo('Initial uri ' + uri);
            setInfo('Encoded uri ' + res);
            $.getJSON("https://as1.reveldigital.com/proxy?url=" + res, function (data) {
				$.each(data, function (index, item) {
                    setInfo('Iterating over ' + item.toString());
                    setLocation(prefs.getString("spotLoc" + idx));
                    setName(prefs.getString("spotName" + idx));
                    setOverview(item.swell.minBreakingHeight, item.swell.maxBreakingHeight, item.swell.unit);
                    setWeatherImage(item.condition.weather);
                    setTide(item.swell.components.combined.height, item.swell.unit);
                    setSwellImage(round5(item.swell.components.combined.direction));
                    setWind(item.wind.speed, item.wind.unit);
                    setWindImage(round5(item.wind.direction));
                    setAir(item.condition.temperature, item.condition.unit);
                    return false;
				});
			});
        }

      
		
        function setLocation(data) {
            setInfo('Setting location ' + data);
			var container = $('#location');
			container.val(data);
		}

        function setName(data) {
            setInfo('Setting location name ' + data);
			var container = $('#location_name');
			container.val(data);
		}

        function setOverview(val1, val2, unit) {
            setInfo('Setting overview ' + val1 + "-" + val2 + " " + unit + " / GOOD");
			var container = $('#overview');
            var t = val1 + "-" + val2 + " " + unit + " / GOOD";
			container.val(t);
		}

        function setWeatherImage(data) {
            setInfo('Setting Weather Image ' + "http://cdnimages.magicseaweed.com/30x30/" + data + ".png");
			var container = $('#weather_icon');
			container.attr("src", "http://cdnimages.magicseaweed.com/30x30/" + data + ".png");
		}

        function setTide(val, unit) {
            setInfo('Setting tide ' + val + " " + unit);
            var container = $('#tide_value');
			container.val(val + " " + unit);
		}

        function setSwellImage(data) {
            setInfo('Setting Swell Image ' + "http://cdnimages.magicseaweed.com/swellArrows/" + data + ".png");
			var container = $('#swell_icon');
			container.attr("src", "http://cdnimages.magicseaweed.com/swellArrows/" + data + ".png");
		}
    
        function setWind(val, unit) {
            setInfo('Setting wind ' + val + " " + unit);
            var container = $('#wind_value');
			container.val(val + " " + unit);
		}

        function setWindImage(data) {
            setInfo('Setting wind Image ' + "http://cdnimages.magicseaweed.com/newWindArrows/" + data + ".png");
			var container = $('#wind_icon');
			container.attr("src", "http://cdnimages.magicseaweed.com/newWindArrows/" + data + ".png");
		}

        function setAir(val ,unit) {
            setInfo('Setting air ' + val + " " + unit);
            var container = $('#air_value');
			container.val(val + " &deg " + unit);
		}
		
		function setInfo(data) {
			if (false) {
				var container = $('#infoContainer');
				container.append(data + '<br>');
			}	
			if (true) {
				console.log(data);
			}
		}

        function round5(x)
        {
            return Math.ceil(x/5)*5;
        }
</script>

<body>
    <div class="table">
        <div class="left">
            <h1 id="location"></h1>
            <p id="location_name"></p>
            <p id="overview"></p>
        </div>
        <div class="right">   
            <table>
                <tr>
                    <td>
                        <img id="weather_icon" src="" align="right" alt="" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="inline">
                            <div id="tide_value"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <img id="swell_icon" src="" align="right" alt="" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="inline">
                            <div id="wind_value"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <img id="wind_icon" src="" align="right" alt="" />
                    </td>
                </tr>
               <tr>
                    <td>
                        <div class="inline">
                            <div id="air_value"></div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>        
    </div>
</body>]]>
</Content>
</Module>