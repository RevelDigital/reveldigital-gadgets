<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
<ModulePrefs title="RevelDigital RSS Slideshow Gadget" description="Rotates through items from an RSS feed" author="RevelDigital" background="transparent">
  <UserPref name="feedUrl" display_name="RSS Feed (URL)" datatype="string" />
  <UserPref name="delay" display_name="Delay between items (seconds)" datatype="string" default_value="10" />
  <UserPref name="numEntries" display_name="Number of items to retrieve" datatype="string" default_value="10" />
</ModulePrefs>
<Content type="html">
<![CDATA[

<style type="text/css">
body *
{
  line-height: 1.2em; 
  letter-spacing: 0; 
  word-spacing: normal; 
}
body
{
  width: 100%;
  height: 100%;
  background: transparent;
}
</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://reveldigital-gadgets.googlecode.com/files/jquery.backstretch.js" type="text/javascript"></script>
<script src="http://reveldigital-gadgets.googlecode.com/files/preload.js" type="text/javascript"></script>

<div id="data">
<ul class="slider">
</ul>
</div>

<script type="text/javascript">

  var prefs = new gadgets.Prefs();
  var images = [];
  var index = 0;
  var transitionSpeed = 500;
  var imageIntervals = prefs.getInt("delay") * 1000;
  var startIntervals;
  var intervalSetTime;
  
  function load() {
    
    update();
    
    setInterval(update, 30 * 60 * 1000);
  }

  gadgets.util.registerOnLoadHandler(load);
</script>

<script type="text/javascript">

  var max_id = 0;
  
  var update = function () {

    images = [];
    
    var feedUrl = encodeURIComponent(prefs.getString("feedUrl"));
    var url = "https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=" + prefs.getInt("numEntries") + "&callback=?&q=" + feedUrl;
    
    $.getJSON(url, function(json) {
      if (json && json.responseStatus == 200) {
        $.each(json.responseData.feed.entries, function (idx0, entry) {
          $.each(entry.mediaGroups, function (idx1, mediaGroup) {
            $.each(mediaGroup.contents, function (idx2, content) {
              if (content.type == "image/jpeg") {
                images.push(content.url);
              }
            });
          });
        });
        $.preload(images, {
          init: function(loaded, total) {
          },
          loaded_all: function(loaded, total) {
              $.backstretch(images[index], {
                speed: transitionSpeed
              });
              startIntervals = function () {
                intervalSetTime = setInterval(function() {
                  index = (index >= images.length - 1) ? 0 : index + 1;
                  $.backstretch(images[index]);
                }, imageIntervals
              )};
              startIntervals();
          }
        });
      }
    });
  }
</script>
]]>
</Content>
</Module>
