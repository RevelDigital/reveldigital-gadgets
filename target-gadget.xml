<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Target India Custom Gadget" description="Cycle through product list fetched from Google Spreadshit" author="RevelDigital" background="transparent">
  <UserPref name="spreadsheetUrl" display_name="Published spreadsheet URL" datatype="string" />
  <UserPref name="delay" display_name="Change product every X seconds" datatype="string" />
</ModulePrefs>
<Content type="html">
<![CDATA[
<style type="text/css">
@import url(https://fonts.googleapis.com/css?family=Montserrat:400,700);

body {
    font-family: Montserrat;
}

#parent {
    width: 100%;
    margin: 0px auto;
}

#container {
    width: 75%;
    margin: 0 auto;
}

#product_image {
	width: 100%;
}

.blank {
	height: 25px;
}

#price {
	color: #B50000;
	font-size: 500%;
}

#location {
	color: #000000;
	font-size: 500%;
}

#product_name {
	color: #000000;
	font-size: 300%;
}

#product_desc {
	color: #000000;
	font-size: 250%;
}

.rectangle{
	padding-top: 10px;
	padding-bottom: 10px;
    width:100%;
    background:#B50000;
	text-align: center;
}

#rect_location {
	color: #FFFFFF;
	font-size: 300%;
}

#rect_discount {
	color: #FFFFFF;
	font-size: 300%;
}
  
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://reveldigital.github.io/reveldigital-gadgets/third-party/tabletop.js" type="text/javascript"></script>

<script type="text/javascript">
	var apiKey = "kOFGVRFEgdmDAZiZhsSG8FfIR22VG1CI";
	var prefs = new gadgets.Prefs();
	var d = [];
	gadgets.util.registerOnLoadHandler(initialize);
 
	function initialize() {		
		Tabletop.init( { key: prefs.getString("spreadsheetUrl"),
							 callback: processData,
							 simpleSheet: true } )
	 }
  
	function processData(data, tabletop) {
		for (i = 0; i < data.length; i++) { 
				setInfo(data[i]);
				setInfo("Product code " + data[i].product_code);
				d[i] = data[i].product_code;
		}
		resolveNext(0);
	}
	
	function resolveNext(idx) {
		setTimeout(function () {
			setInfo('Data has '  + d);
			setInfo('Current Item '  + d[idx]);
			var uri = "http://stage-api.target.com/products/v3/" + d[idx] + "?id_type=dpci&store_id=530&mode=online&fields=ids,locations,images,brand,descriptions,pricing,in_store_locations&key=" + apiKey;
            var res = encodeURIComponent(uri);
            setInfo('Initial uri ' + uri);
            setInfo('Encoded uri ' + res);
            $.getJSON("https://as1.reveldigital.com/proxy?url=" + res, function (data) {
				$.each(data, function (index, item) {
                    setInfo(item);
					setPrice(item.items[0].online_price.current_price);
					setLocation(item.items[0].location_id);
					setImage(item.items[0].image.external_primary_image_url[0]);
					setTitle(item.items[0].reference_data.manufacturer_brand);
					setDescription(item.items[0].online_description.value);
				});
			});
			if (++idx < d.length) {
				resolveNext(idx);
			}
		}, 1000 * parseInt(prefs.getString("delay")))
     }
	 
	function setPrice(data) {
		setInfo('Setting price ' + data);
		var container = $('#price');
		container.text("$" + data);
	}

	function setLocation(data) {
		setInfo('Setting location' + data);
		var container = $('#location');
		var container2 = $('#rect_location');
		container.text(data);
	}

	function setImage(data) {
		setInfo('Setting Image ' + data);
		var container = $('#product_image');
		container.attr("src", data);
	}

	function setTitle(data) {
		setInfo('Setting Title ' + data);
		var container = $('#product_name');
		container.text(data);
	}

	function setDescription(data) {
		setInfo('Setting Desc ' + data);
		var container = $('#product_desc');
		container.text(data);
	}
	
	function setInfo(data) {
		if (false) {
			var container = $('#infoContainer');
			container.append(data + '<br>');
		}	
		if (true) {
			console.log(data);
		}
		if (false) {
			alert(data);
		}
	}
  
  
   
</script>
<body>
	<div id="parent">  
		<div id="container">
			<img id="product_image" src=""></img>
			<div class="blank"></div>
			<div>
				<table width="100%">
					<tr>
						<td style="text-align: left;">
							<p id="price">$3.24</p>
						</td>
						<td style="text-align: right;">
							<p id="location">A20 F</p>
						</td>
					</tr>
					<tr>
						<td colspan= "2" style="text-align: left;">
							<p id="product_name">Simply Balanced</p>
						</td>
					</tr>
					<tr>
						<td colspan= "2" style="text-align: left;">
							<p id="product_desc">Organic Tomato Basil Pasta Sauce</p>
						</td>
					</tr>
				</table>
			</div>
			<div class="blank"></div>
			<div class="rectangle">
				<p id="rect_location">Organic Tomato Basil Pasta Sauce</p>
			</div>
			<div class="blank"></div>
			<div class="rectangle">
				<p id="rect_discount">20% OFF</p>
			</div>
		</div>
	</div>
</body>]]>
</Content>
</Module>