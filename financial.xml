<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital Financial Gadget" description="Basic financials for a user defined list of stock symbols" author="RevelDigital" background="transparent">
  <UserPref name="symbols" display_name="Stock Symbols (eg. MSFT,AIG,JPM)" datatype="string" />
</ModulePrefs>
<Content type="html">
<![CDATA[

<style type="text/css">
body *
{
  font-family: Verdana, arial, sans-serif; 
  line-height: 1.2em; 
  letter-spacing: 0; 
  word-spacing: normal; 
}

body
{
  background: transparent;
}

div.quotescontainer
{
  text-align: left;
  overflow: hidden;
}

.symbol
{
  font-size: 150%;
  text-align: left;
  font-weight: bold;
}

td, th
{
  padding: 10px;
}

th
{
  font-weight: bold;
  font-color: #888;
  font-size: 120%;
  text-align: right;
}

img
{
  height: 32px;
  width: 32px;
}

.value
{
  font-size: 150%;
  text-align: right;
}

.when
{
  opacity: 0.7;
  margin-top: 2px;
  text-align: right;
}
</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<div class="quotescontainer">
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Last</th>
        <th></th>
        <th>Change</th>
        <th>% Change</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script type="text/javascript">

  var prefs = new gadgets.Prefs();

  function load() {
  
    $("div.quotescontainer").height($(window).height()).width($(window).width());
    $("div.quotescontainer table").css("color", prefs.getString("ForeColor"));
    $("div.quotescontainer").css("background-color", prefs.getString("BackColor"));
    
    update();
    
    setInterval(update, 120000);
  }

  gadgets.util.registerOnLoadHandler(load);
</script>

<script type="text/javascript">

  var max_id = 0;
  
  var update = function () {

    var url="http://www.google.com/finance/info?infotype=infoquoteall&callback=?&q=";
    var query = escape( query=prefs.getString("symbols") );
  
    $.getJSON(url+query, function(json){
            
      if(json) {
      
        $("div.quotescontainer > table > tbody").empty();
        
        var display = '';
        var when = '';
        $.each(json,function(i, quote) {
          display += '<tr class="item">';
          display += '<td class="symbol">' + quote.t + '</td>';
          display += '<td class="value">' + quote.l + '</td>';
          if (parseInt(quote.l) >= 0) {
            display += '<td class="icon"><img src="http://reveldigital-gadgets.googlecode.com/svn/trunk/images/up_arrow_48.png" alt=""/></td>';
          } else {
            display += '<td class="icon"><img src="http://reveldigital-gadgets.googlecode.com/svn/trunk/images/down_arrow_48.png" alt=""/></td>';
          }
          display += '<td class="value">' + quote.c + '</td>';
          display += '<td class="value">' + quote.cp + '%</td>';
          display += '</tr>';
          when = quote.lt;
        });
        display += '<tr><td class="when" colspan="5">Last updated: ' + when + '</td></tr>';
        
        $(display).hide().prependTo("div.quotescontainer > table > tbody").fadeIn();
      }
    });
  }

  var timeAgo = function (dateString) {
    var rightNow = new Date(),
    then = new Date(dateString),
    diff = rightNow - then,
    second = 1000,
    minute = second * 60,
    hour = minute * 60,
    day = hour * 24,
    week = day * 7;
  
    if (isNaN(diff) || diff < 0) {
      return "";	//Return blank string if unknown
    }
  
    if (diff < second * 2) {
      return "right now";
    }
  
    if (diff < minute) {
      return Math.floor(diff / second) + " seconds ago";
    }
  
    if (diff < minute * 2) {
      return "about 1 minute ago";
    }
  
    if (diff < hour) {
      return Math.floor(diff / minute) + " minutes ago";
    }
  
    if (diff < hour * 2) {
      return "about 1 hour ago";
    }
  
    if (diff < day) {
      return  Math.floor(diff / hour) + " hours ago";
    }
  
    if (diff > day && diff < day * 2) {
      return "yesterday";
    }
  
    if (diff < day * 365) {
      return Math.floor(diff / day) + " days ago";
    }
    else {
      return "over a year ago";
    }
  }
</script>
]]>
</Content>
</Module>