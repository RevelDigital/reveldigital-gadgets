<?xml version="1.0" encoding="UTF-8" ?> 
<Module> 
<ModulePrefs title="RevelDigital RSS Scroller" description="Rotates through RSS feed items" author="RevelDigital" background="transparent">
  <UserPref name="feedUrl" display_name="RSS feed URL" datatype="string" />
  <UserPref name="showHeader" display_name="Display feed title" datatype="bool" default_value="true" />
  <UserPref name="maxItems" display_name="Maximum number of feed items" datatype="string" default_value="10" />
  <UserPref name="pause" display_name="Delay in seconds between items" datatype="string" default_value="5" />
  <UserPref name="showDate" display_name="Display the post date" datatype="bool" default_value="true" />
  <UserPref name="header-style" display_name="Header Style" datatype="style" default_value="font-family:Open Sans;color:rgb(255, 255, 255);font-size:24px;" required="true" />
  <UserPref name="title-style" display_name="Title Style" datatype="style" default_value="font-family:Noto Serif;color:rgb(255, 255, 255);font-size:24px;" required="true" />
  <UserPref name="date-style" display_name="Dateline Style" datatype="style" default_value="font-family:Open Sans;color:#A6A6A6;font-size:18px;font-weight:bold" required="true" />
  <UserPref name="body-style" display_name="Body Style" datatype="style" default_value="font-family:Open Sans;color:rgb(255, 255, 255);font-size:18px;" required="true" />
  <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
  <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" />
</ModulePrefs>
<Content type="html">
<![CDATA[

<style type="text/css">
        
    * {
        box-sizing: border-box;
    }

    body * {
        line-height: 1.2em;
        letter-spacing: 0;
        word-spacing: normal;
    }

    body {
        background: transparent;
        width: 1018px;
        height: 788px;
        overflow: hidden;
    }

    .row::after {
        content: "";
        clear: both;
        display: table;
    }

    [class*="col-"] {
        float: left;
        padding: 15px;
    }

    .col-1 {width: 8.33%;}
    .col-2 {width: 16.66%;}
    .col-3 {width: 25%;}
    .col-4 {width: 33.33%;}
    .col-5 {width: 41.66%;}
    .col-6 {width: 50%;}
    .col-7 {width: 58.33%;}
    .col-8 {width: 66.66%;}
    .col-9 {width: 75%;}
    .col-10 {width: 83.33%;}
    .col-11 {width: 91.66%;}
    .col-12 {width: 100%;}

    #header h1 {
        __UP_header-style__;
    }
    
    .item-date { 
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        color: #A6A6A6;
        margin-bottom: 35px;
        __UP_date-style__;
    }

    .item-date img {
        display: block;
        width: 1.8em;
        margin-right: 20px;
    }
  
    .item-title {
        __UP_title-style__;
    }
  
    .item-content {
        __UP_body-style__;
    }
</style>

<!-- Add the slick-theme.css if you want default styling -->
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
<!-- Add the slick-theme.css if you want default styling -->
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="https://reveldigital.github.io/gadget-common/utils.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
<script type="text/javascript" src="https://reveldigital.github.io/gadget-common/third-party/jquery.rss.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

<div id="container">
</div>

<script type="text/javascript">
    var prefs = new gadgets.Prefs();

    function load() {

        WebFont.load({
            google: {
              families: [
                  RevelDigital.getFamilyName(prefs.getString("header-style"))
              ]
            }
        });
        WebFont.load({
            google: {
              families: [
                  RevelDigital.getFamilyName(prefs.getString("title-style"))
              ]
            }
        });
        WebFont.load({
            google: {
                families: [
                    RevelDigital.getFamilyName(prefs.getString("body-style"))
                ]
            }
        });
        WebFont.load({
            google: {
                families: [
                    RevelDigital.getFamilyName(prefs.getString("date-style"))
                ]
            }
        });

        update();

        setInterval(update, 30 * 60 * 60 * 1000); // 30 minutes
    }

    var update = function () {

        try {
            $('#rss-feeds').slick('unslick');
        } catch (e) { }
        $('#container').empty();
        
        var url = "https://revel-rss-feed-parser.herokuapp.com/?q=" + encodeURI(prefs.getString("feedUrl"));

        $.getJSON(url, function(data) {

            if (prefs.getBool('showHeader')) {
                $('#container').append(
                    `<div id="header" class="row"><div class="col-2"><img src="${data.image.url}" width="100%"></div><div class="col-10"><h1>${data.description}</h1></div>`
                );
            }
            $('#container').append('<div id="rss-feeds"></div>');
            
            $.each(data.items, function(i, item) {
            
                if (i > prefs.getInt("maxItems")) {
                    return false;
                }
                
                $('#rss-feeds').append(
                    item.mediagroup ?
                    `<div class="row">
                      <div class="col-6">
                          <div class="item-title">
                              <h1>${item.title}</h1>
                          </div>
                          <div class="item-date">
                              <img src="https://reveldigital.github.io/reveldigital-gadgets/images/pubdate.svg"><span>${timeAgo(item.pubDate)}</span>
                          </div>
                          <div class="item-content">${item.contentSnippet}</div>
                      </div>
                      <div class="col-6 item-img">
                          <img src="${item.mediagroup[0]['media:content'][0].$.url}" width="100%">
                      </div>
                    </div>` : 
                    `<div class="row">
                      <div class="col-12">
                          <div class="item-title">
                              <h1>${item.title}</h1>
                          </div>
                          <div class="item-date">
                              <img src="https://reveldigital.github.io/reveldigital-gadgets/images/pubdate.svg"><span>${timeAgo(item.pubDate)}</span>
                          </div>
                          <div class="item-content">${item.contentSnippet}</div>
                      </div>
                    </div>`
                );
            });

            $('#rss-feeds').slick({
                dots: false,
                arrows: false,
                infinite: true,
                slidesToShow: 1,
                slidesToScroll: 1,
                autoplay: true,
                variableWidth: false,
                responsive: [
                    {
                        breakpoint: 1080,
                        settings: {
                            variableWidth: false,
                        }
                    }],
                autoplaySpeed: prefs.getInt('pause') * 1000,
                autoplay: true,
                fade: (prefs.getString('transition') == 'fade'),
                lazyLoad: 'progressive'
            });
        });
    }

    var timeAgo = function (date) {
        var dt = moment(date);
        if (!dt.isValid()) return "N/A";

        return moment.duration(dt - moment()).humanize(true);
    }

    gadgets.util.registerOnLoadHandler(load);
</script>

]]>
</Content>
</Module>
